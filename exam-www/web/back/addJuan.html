<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style type="text/css">
        <!--
        .tit {
            font-size: 12px;
            color: #0022ff;
            font-weight: bold;
        }

        .tit td {
            border: 1px solid #0066ff
        }

        #chanel td {
            border: 1px solid #0066ff;
            font-size: 12px;
            color: #000000
        }

        td {
            font-size: 12px;
        }

        .sta td {
            border: none;
        }

        .titbg td {
            background: #e3fafd;
            font-size: 12px;
            color: #000000;
            border: none;
            border-bottom: 1px #0066ff solid;
            border-top: 1px #0066ff solid;
        }

        td img {
            display: block;
        }

        .bqta td {
            font-size: 12px;
            color: #666666;
        }

        body {
            background-repeat: no-repeat;
            margin-top: 50px;
        }

        a {
            font-size: 12px;
            color: #000055;
            text-decoration: none;
        }

        a:hover {
            color: #0033ff;
            text-decoration: underline;
        }

        .STYLE4 {
            color: #FFFFFF;
            font-weight: bold;
            font-size: 14px;
        }

        .btns {
            height: 24px;
            width: 90px;
        }

        .STYLE5 {
            color: #0000FF
        }

        .STYLE21 {
            font-size: 12px;
            font-weight: bold;
        }

        -->


    </style>
</head>

<body>

<form onsubmit="return false;" id="addExamineForm">

    <table width="732" border="0" align="center" cellpadding="0" cellspacing="0">
        <tr class="tit">
            <td height="30" colspan="5" align="center" bgcolor="#80FFFF">新增考试（*项为必填项）</td>
        </tr>
        <tr>
            <td width="95" height="40" align="right" valign="middle" bgcolor="#FFFFFF"
                style="border:none; line-height:28px;border-left:1px #0066ff solid;">试卷名称[<span class="STYLE5">*</span>]：
            </td>
            <td width="346" colspan="4" height="40" align="left" bgcolor="#FFFFFF" style="border:none;"><span
                    style="border:none; border-right:1px #0066ff solid;">
      <input type="text" name="name" value="" style="height:26px; width:340px;  border:1px solid #666666">
                <input name="topicIds" type="hidden">
                <input name="esessionIds" type="hidden">
    </span></td>
            <!--<td width="111" align="right" bgcolor="#FFFFFF" style="border:none">分值：</td>-->
            <!--<td width="165" align="left" bgcolor="#FFFFFF" style="border:none;"><input type="text"-->
            <!--name="score"-->
            <!--value=""-->
            <!--style="height:26px; width:100px;  border:1px solid #666666">-->
            <!--</td>-->
            <!--<td width="15" align="left" bgcolor="#FFFFFF" style="border:none; border-right:1px #0066ff solid;">-->
            <!--&nbsp;-->
            <!--</td>-->
        </tr>
        <tr>
            <td height="38" align="right" valign="middle" bgcolor="#FFFFFF"
                style="border:none;border-left:1px #0066ff solid;">考试模式[<span class="STYLE5">*</span>]：
            </td>
            <td height="38" colspan="4" align="left" bgcolor="#FFFFFF"
                style="border:none;border-right:1px #0066ff solid;"><span
                    style="border:none; border-right:1px #0066ff solid;">
                <select name="type"
                        style=" width:140px; height:30px;">
                                        <option value="1" >普通模式</option>
                                        <option value="2" selected>随机模式</option>
                                    </select>
        </span></td>
        </tr>
        <tr>
            <td height="28" colspan="5" align="center" valign="top" bgcolor="#FFFFFF" class="STYLE21"
                style=" line-height:28px;border:1px #0066ff solid;border-bottom:3px solid #0066FF">添加试题（*）
            </td>
        </tr>
        <tr>
            <td height="8" colspan="5" bgcolor="#FFFFFF" style=" border:1px #0066ff solid; border-bottom:none "></td>
        </tr>
        <tr>
            <td height="103" colspan="5" align="center" valign="top" bgcolor="#FFFFFF"
                style="border:none; line-height:28px;border-left:1px #0066ff solid;border-right:1px #0066ff solid;">
                <table width="660" border="0" align="center" cellpadding="0" cellspacing="0" class="sta">
                    <tr bgcolor="#00FFFF">
                        <td width="101" align="center" valign="middle" class="STYLE21">序号</td>
                        <td width="219" height="30" align="center" valign="middle"><span class="STYLE21">试题名称</span>
                        </td>
                        <td width="144" align="center" valign="middle" class="STYLE21">试题类型</td>
                        <td width="104" align="center" valign="middle"><strong class="STYLE21">分值</strong></td>
                        <td width="92" align="center" valign="middle" class="STYLE21">查看</td>
                    </tr>
                    <tr>
                        <td height="30" colspan="5" align="center" valign="middle">&nbsp;</td>
                    </tr>
                    <tbody id="topicTable">

                    </tbody>
                    <tr>
                        <td height="30" colspan="5" align="center" valign="bottom" style="border:none;"><input
                                id="addTopicBtn"
                                type="submit"
                                name="Submit2"
                                value="添加题目"
                                style="height:26px;"/>
                        </td>
                    </tr>
                    <tr>
                        <td height="12" colspan="5" align="center" valign="bottom" style="border:none;"></td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td height="28" colspan="5" align="center" valign="top" bgcolor="#FFFFFF" class="STYLE21"
                style=" line-height:28px;border:1px #0066ff solid;border-bottom:3px solid #0066FF">添加场次（*）
            </td>
        </tr>
        <tr>
            <td height="8" colspan="5" bgcolor="#FFFFFF" style=" border:1px #0066ff solid; border-bottom:none "></td>
        </tr>
        <tr>
            <td height="103" colspan="5" align="center" valign="top" bgcolor="#FFFFFF"
                style="border:none; line-height:28px;border-left:1px #0066ff solid;border-right:1px #0066ff solid;">
                <table width="660" border="0" align="center" cellpadding="0" cellspacing="0" class="sta">
                    <tr bgcolor="#00FFFF">
                        <td width="101" align="center" valign="middle" class="STYLE21">序号</td>
                        <td width="219" height="30" align="center" valign="middle"><span class="STYLE21">场次名称</span>
                        </td>
                        <td width="144" align="center" valign="middle" class="STYLE21">开始时间</td>
                        <td width="104" align="center" valign="middle"><strong class="STYLE21">结束时间</strong></td>
                        <td width="104" align="center" valign="middle"><strong class="STYLE21">操作</strong></td>
                    </tr>
                    <tr>
                        <td height="30" colspan="5" align="center" valign="middle">&nbsp;</td>
                    </tr>
                    <tbody id="esessionTable">

                    </tbody>
                    <tr>
                        <td height="30" colspan="5" align="center" valign="bottom" style="border:none;"><input
                                id="addEsessionBtn"
                                type="submit"
                                name="Submit2"
                                value="添加场次"
                                style="height:26px;"/>
                        </td>
                    </tr>
                    <tr>
                        <td height="12" colspan="5" align="center" valign="bottom" style="border:none;"></td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td height="33" colspan="5" align="center" bgcolor="#FFFFFF" style="border:1px solid #0066ff;"><input
                    type="button" name="add" value="保 存" id="submitBtn">
                &nbsp;
                <input type="button" name="Cancel" value="取 消" onClick="javascript:self.history.back();">
            </td>
        </tr>
    </table>
</form>

<script src="./imges/jquery.min.js"></script>
<script src="./imges/My97DatePicker/WdatePicker.js"></script>
<script src="./imges/common.js"></script>
<script>

    var topicList = [],
        esessionList = [];
    function removeTopic(id, t) {

        var l = [],
            list = t == 1 ? topicList : esessionList,
            m = t == 1 ? setTopics : setEsessions;

        for (var i = 0, len = list.length; i < len; i++) {
            if (list[i].id != id) {
                l.push(list[i]);
            }
        }
        m(l);
    }
    function setTopics(rs) {
        topicList = rs;
        if (rs) {
            var html = [],
                allScore = 0,
                topicIds = [];

            for (var i = 0, len = rs.length; i < len; i++) {
                var r = rs[i];
                allScore += r.score;
                topicIds.push(r.id);
                html.push('<tr>                                                                                ')//
                html.push('        <td width="101" align="center" valign="middle" class="STYLE21">' + (i + 1) + '</td>                        ')//
                html.push('        <td width="219" height="30" align="center" valign="middle"><span class="STYLE21">' + r.name + '</span>  ')//
                html.push('        </td>                                                                                         ')//
                html.push('        <td width="144" align="center" valign="middle" class="STYLE21">' + (r.type == 1 ? '对照复录' : '听音打字') + '</td>                      ')//
                html.push('        <td width="104" align="center" valign="middle"><strong class="STYLE21">' + r.score + '</strong></td>       ')//
                html.push('        <td width="92" align="center" valign="middle" class="STYLE21"><a href="' + (App.basePath + '/back/xiangxiTi.html?id=' + r.id) + '" target="_self">查看</a>&nbsp;|&nbsp;' +
                    '<a href="javascript:removeTopic(' + r.id + ',1)">删除</a></td>                         ')//
                html.push('        </tr>                                                                                         ')//
            }

            $('#topicTable').html(html.join(''));
            $('input[name=score]').val(allScore);
            $('input[name=topicIds]').val(topicIds.join(','));
        }
    }

    function setEsessions(rs) {

        esessionList = rs;
        if (rs) {
            var html = [],
                esessionIds = [];

            for (var i = 0, len = rs.length; i < len; i++) {
                var r = rs[i];
                esessionIds.push(r.id);
                html.push('<tr>                                                                                ')//
                html.push('        <td width="101" align="center" valign="middle" class="STYLE21">' + (i + 1) + '</td>                        ')//
                html.push('        <td width="219" height="30" align="center" valign="middle"><span class="STYLE21">' + r.name + '</span>  ')//
                html.push('        </td>                                                                                         ')//
                html.push('        <td width="144" align="center" valign="middle" class="STYLE21">' + r.startTime + '</td>                      ')//
                html.push('        <td width="104" align="center" valign="middle"><strong class="STYLE21">' + r.endTime + '</strong></td>       ')//
                html.push('        <td width="92" align="center" valign="middle" class="STYLE21">&nbsp;' +
                    '<a href="javascript:removeTopic(' + r.id + ',2)">删除</a></td>                         ')//
                html.push('        </tr>                                                                                         ')//
            }

            $('#esessionTable').html(html.join(''));
            $('input[name=esessionIds]').val(esessionIds.join(','));
        }
    }

    function addTopics(ts) {
        for (const t of ts) {
            if (!topicList.includes(t)) {
                topicList.push(t)
            }
        }
        setTopics(topicList)
    }

    function addEsessions(es) {
        for (const e of es) {
            if (!esessionList.includes(e)) {
                esessionList.push(e)
            }
        }
        setEsessions(esessionList)
    }

    $(function () {

        $('#addTopicBtn,#addEsessionBtn').on('click', function () {
            if (self.frames.length == 0) {
                var id = $(this).attr('id');
                if (id == 'addTopicBtn') {
                    self.open(App.basePath + '/back/tiList.html?isChoose=1&method=addTopics', '_choose', 'width=700,height=400');
                } else {
                    self.open(App.basePath + '/back/esList.html?isChoose=1&method=addEsessions', '_choose', 'width=700,height=400');
                }
            }
        });

        $('#submitBtn').on('click', function () {
            var btn = $(this),
                form = btn.parents('form'),
                nameIn = $('[name=name]', form),
                typeIn = $('[name=type]', form),
//                startTimeIn = $('[name=startTime]', form),
                topicIdsIn = $('[name=topicIds]', form),
                esessionIdsIn = $('[name=esessionIds]', form)
//                endTimeIn = $('[name=endTime]', form);

            var nameVal = $.trim(nameIn.val()),
//                startTimeVal = $.trim(startTimeIn.val()),
                typeVal = $.trim(typeIn.val()),
                esessionIdsVal = $.trim(esessionIdsIn.val()),
                topicIdsVal = $.trim(topicIdsIn.val())
//                endTimeVal = $.trim(endTimeIn.val())

            if (!nameVal) {
                alert('请输入考试名称！');
                return false;
            }
            if (!esessionIdsVal) {
                alert('请选择至少一个考试场次！');
                return false;
            }
//            if (!startTimeVal) {
//                alert('请选择考试开始时间！');
//                return false;
//            }
//            if (!endTimeVal) {
//                alert('请选择考试结束时间！');
//                return false;
//            }

            var params = {
                name: nameVal,
//                startTime: startTimeVal,
//                endTime: endTimeVal,
                type: typeVal,
                esessionIds: esessionIdsVal,
                topicIds: topicIdsVal || ''
            }
            $.post(App.basePath + '/back/examine/add.do', params, function (data) {

                if (data && data.success) {
                    alert('添加考试成功！');
                    self.location.assign(App.basePath + '/back/juanList.html');
                } else {
                    alert(data && data.errmsg ? data.errmsg : 'error');
                }
            }, 'json');

        })
    })


</script>
</body>
</html>