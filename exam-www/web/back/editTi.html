<html>

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style type="text/css">
        <!--
        .tit {
            font-size: 12px;
            color: #0022ff;
            font-weight: bold;
        }

        .tit td {
            border: 1px solid #0066ff
        }

        #chanel td {
            border: 1px solid #0066ff;
            font-size: 12px;
            color: #000000
        }

        td {
            font-size: 12px;
        }

        .sta td {
            border: none;
        }

        .titbg td {
            background: #e3fafd;
            font-size: 12px;
            color: #000000;
            border: none;
            border-bottom: 1px #0066ff solid;
            border-top: 1px #0066ff solid;
        }

        td img {
            display: block;
        }

        .bqta td {
            font-size: 12px;
            color: #666666;
        }

        body {
            background-repeat: no-repeat;
            margin-top: 50px;
        }

        a {
            font-size: 12px;
            color: #000055;
            text-decoration: none;
        }

        a:hover {
            color: #0033ff;
            text-decoration: underline;
        }

        .STYLE4 {
            color: #FFFFFF;
            font-weight: bold;
            font-size: 14px;
        }

        .btns {
            height: 24px;
            width: 90px;
        }

        .STYLE5 {
            color: #0000FF
        }

        .appendix_con {
            display: none;
        }

        -->
    </style>
</head>

<body>

<form id="editTopicForm" onsubmit="return false;">

    <table width="732" border="0" align="center" cellpadding="0" cellspacing="0">
        <tr class="tit">
            <td height="30" colspan="5" align="center" bgcolor="#80FFFF">修改题目(*项为必填项）</td>
        </tr>
        <tr>
            <td width="95" height="35" align="right" valign="middle" bgcolor="#FFFFFF"
                style="border:none; line-height:28px;border-left:1px #0066ff solid;">题目名称[<span class="STYLE5">*</span>]：
            </td>
            <td height="35" colspan="3" align="left" bgcolor="#FFFFFF" style="border:none;"><span
                    style="border:none; border-right:1px #0066ff solid;">
                <input name="id" value="" type="hidden">
      <input type="text" name="name" value=""
             style="height:26px; width:580px;  border:1px solid #666666">
    </span></td>
            <td width="15" align="left" bgcolor="#FFFFFF" style="border:none; border-right:1px #0066ff solid;">
                &nbsp;
            </td>
        </tr>
        <tr>
            <td height="35" align="right" valign="middle" bgcolor="#FFFFFF"
                style="border:none; line-height:28px;border-left:1px #0066ff solid;">题目分值[<span class="STYLE5">*</span>]：
            </td>
            <td width="280" height="35" align="left" bgcolor="#FFFFFF" style="border:none;"><input type="text"
                                                                                                   name="score"
                                                                                                   value=""
                                                                                                   style="height:26px; width:80px;  border:1px solid #666666">
                分
            </td>
            <td width="98" align="right" bgcolor="#FFFFFF" style="border:none">试题类型[<span class="STYLE5">*</span>]：</td>
            <td width="244" align="left" bgcolor="#FFFFFF" style="border:none;"><select
                    onchange="toggleContent(this.value)" name="type"
                    style="width:140px; height:26px; margin:0px;">
                <option value="1">对照复录</option>
                <option value="2">听音打字</option>
            </select></td>
            <td align="left" bgcolor="#FFFFFF" style="border:none; border-right:1px #0066ff solid;">&nbsp;</td>
        </tr>
        <tr>
            <td height="35" align="right" valign="middle" bgcolor="#FFFFFF"
                style="border:none; line-height:28px;border-left:1px #0066ff solid;">答题时间[<span class="STYLE5">*</span>]：
            </td>
            <td colspan="4" width="280" height="35" align="left" bgcolor="#FFFFFF" style="border:none;"><input
                    type="text"
                    name="period"
                    value=""
                    style="height:26px; width:80px;  border:1px solid #666666">
                分
            </td>
        </tr>
        <tr>
            <td height="13" align="right" valign="middle" bgcolor="#FFFFFF"
                style="border:none;border-left:1px #0066ff solid;"></td>
            <td height="13" colspan="4" align="left" bgcolor="#FFFFFF"
                style="border:none;border-right:1px #0066ff solid;"></td>
        </tr>
        <tr class="text_con">
            <td height="150" align="right" valign="top" bgcolor="#FFFFFF"
                style="border:none; line-height:28px;border-left:1px #0066ff solid;">试题内容[<span class="STYLE5">*</span>]：
            </td>
            <td height="150" colspan="4" align="left" valign="top" bgcolor="#FFFFFF"
                style="border:none; border-right:1px #0066ff solid;"><span style="border:none">
      <textarea name="content" id="neirong" class="ckeditor"
                style="border:1px solid #999999; width:600px; height:140px;"></textarea>
    </span></td>
        </tr>
        <tr class="appendix_con">
            <td height="160" align="right" valign="top" bgcolor="#FFFFFF"
                style="border:none; border-left:1px #0066ff solid; line-height:40px;">参考答案[<span class="STYLE5">*</span>]：
            </td>
            <td colspan="4" align="left" valign="top" bgcolor="#FFFFFF"
                style="border:none; border-right:1px #0066ff solid; font-size:12px; line-height:22px;">
            <textarea name="answer" id="textarea" class="ckeditor"
                      style="border:1px solid #999999; width:600px; height:140px;"></textarea>
                <!--<br> &nbsp;&nbsp;&nbsp;&nbsp;对于打字类题目，答案即也为题目一部分，题目中不再重复录入-->
            </td>
        </tr>
        <tr class="appendix_con">
            <td rowspan="2" align="right" valign="top" bgcolor="#FFFFFF"
                style="border:none; border-left:1px #0066ff solid; line-height:40px;">附件：
            </td>
            <td height="27" colspan="4" align="left" valign="middle" bgcolor="#FFFFFF"
                style="border:none; border-right:1px #0066ff solid; font-size:12px" id="existAppendix"></td>
        </tr>
        <tr class="appendix_con">
            <td colspan="4" align="left" valign="middle" bgcolor="#FFFFFF"
                style="border:none; border-right:1px #0066ff solid; font-size:12px"><input id="fileupload" type="file"
                                                                                           name="file"
                                                                                           style="width:500px; height:30px;">
                <input name="filePath" type="hidden">
            </td>
        </tr>
        <tr class="appendix_con">
            <td align="right" valign="top" bgcolor="#FFFFFF"
                style="border:none; border-left:1px #0066ff solid; line-height:40px;">&nbsp;
            </td>
            <td colspan="4" align="left" valign="middle" bgcolor="#FFFFFF"
                style="border:none; border-right:1px #0066ff solid; font-size:12px">
                <label>
                    <input type="radio" name="playtype" value="1" checked>
                </label>专门用户集中播放（适合考场使用音响广播等）
                <label>
                    <input type="radio" name="playtype" value="2">
                </label>考试独立播放（适合每个考试终端有耳机）
            </td>
        </tr>
        <tr>
            <td height="33" colspan="5" align="center" bgcolor="#FFFFFF" style="border:1px solid #0066ff;"><input
                    type="button" name="add" value="保 存" id="saveBtn">
                &nbsp;
                <input type="button" name="Cancel" value="取 消"
                       onClick="javascript:self.history.back();"></td>
        </tr>
    </table>
</form>
<script src="./imges/jquery.min.js"></script>
<script src="./imges/jquery.ui.widget.js"></script>
<script src="./imges/jquery.iframe-transport.js"></script>
<script src="./imges/jquery.fileupload.js"></script>
<script src="./imges/common.js"></script>
<script>

    function toggleContent(v) {
        if (v == 1) {
            $('.text_con').show();
            $('.appendix_con').hide();
        } else {
            $('.text_con').hide();
            $('.appendix_con').show();
        }
    }

    function deleteFile(val) {

        $('#existAppendix').html('');
        $('input[name=filePath]').val('');
    }

    function premiumListen(val) {
        App.audioplayer('premiumListen', {mp3: App.basePath + '/back/file/download.do?fullPath=' + encodeURIComponent(val)}, true)
    }

    function showAppendix(val) {
        var h = '已有附件：' + App.parseFileName(val) + ' &nbsp;&nbsp;<a href="javascript:premiumListen(\'' + val.replace(/\\/g, '\\\\') + '\')">试听</a>&nbsp;&nbsp;<a href="javascript:deleteFile(\'' + val + '\')">删除</a>';
        $('#existAppendix').html(h);

        $('input[name=filePath]').val(val);
    }

    $(function () {

        var id = App.getParam('id');
        if (!id) {
            alert('参数错误！');
            return
        }

        $.get(App.basePath + '/back/topic/detail.do', {id: id}, function (data) {

            if (!data) {
                return
            }
            if (!data.success) {
                alert('错误：' + data.errmsg);
                return;
            }
            var form = $('#editTopicForm'),
                inputs = $('input,select,textarea', form).not(':button'),
                obj = data.obj;

            var topicType = obj['type'];

            if (topicType == 1) {
                $('.appendix_con').hide();
                $('.text_con').show();
            } else {
                $('.appendix_con').show();
                $('.text_con').hide();
            }
            inputs.each(function () {

                var ip = $(this),
                    name = ip.attr('name'),
                    tag = this.tagName.toLocaleLowerCase(),
                    val = obj[name] || '';

                if (name == 'file' || name == 'filePath') return;
//                console.log('name', name, val);
                if (tag == 'input' || tag == 'textarea') {
                    if (name == 'content') {
                        if (topicType == 1) {
                            ip.val(val);
                        } else {
                            showAppendix(val);
                        }
                    } else if (ip.is(':radio')) {
                        form[0][name].value = val;
                    } else {
                        ip.val(val);
                    }
                } else if (tag == 'select') {
                    this.value = val;
                }
            });


        }, 'json');

        $('#fileupload')
            .attr('data-url', App.basePath + '/back/file/upload.do')
            .fileupload({
                dataType: 'json',
                done: function (e, data) {
                    var obj = data.result;
                    if (obj && obj.success) {
                        showAppendix(obj.obj);
                    }
                }
            });

        $('#saveBtn').on('click', function () {

            var btn = $(this),
                form = btn.parents('form'),
                idInput = $('[name=id]', form),
                typeInput = $('[name=type]', form),
                nameInput = $('[name=name]', form),
                scoreInput = $('[name=score]', form),
                contentInput = $('[name=content]', form),
                periodInput = $('[name=period]', form),
                answerInput = $('[name=answer]', form),
                filePathInput = $('[name=filePath]', form);

            var nameVal = $.trim(nameInput.val()),
                idVal = $.trim(idInput.val()),
                scoreVal = $.trim(scoreInput.val()),
                typeVal = typeInput.val(),
                contentVal = $.trim(contentInput.val()),
                periodVal = $.trim(periodInput.val()),
                filePathVal = $.trim(filePathInput.val()),
                answerVal = $.trim(answerInput.val()),
                playtypeVal = $.trim(form[0].playtype.value),
                content;

            if (!nameVal) {
                alert("题目名称不能为空！")
                return false;
            }

            if (!scoreVal || isNaN(scoreVal)) {
                alert("分数不能为空且必须是数字！");
                return false;
            }
            if (!periodVal || isNaN(periodVal)) {
                alert("答题时间不能为空且必须是数字！");
                return false;
            }

            if (typeVal == 1) {
                if (!contentVal) {
                    alert("选择[对照复录]类型题目必须输入[试题内容]！");
                    return false;
                }

                content = contentVal;
            }
            if (typeVal == 2) {
                if (!filePathVal) {
                    alert('选择[听音打字]类型题目必须先上传音频文件！');
                    return false;
                }
                if (!answerVal) {
                    alert('选择[听音打字]类型题目必须填写参考答案！');
                    return false;
                }

                content = filePathVal;
            }

            var params = {
                id: idVal,
                name: nameVal,
                type: typeVal,
                score: scoreVal,
                period: periodVal,
                content: content,
                playtype: playtypeVal,
                answer: typeVal == 1 ? content : answerVal
            }

            $.post(App.basePath + '/back/topic/edit.do', params, function (data) {
                if (!data) {
                    return;
                }
                if (data.success) {
                    alert('修改试题成功！');
                    window.self.location.assign(App.basePath + '/back/tiList.html');
                } else {
                    alert('发生错误：' + data.errmsg);
                }
            }, 'json');
        })
    })
</script>
</body>
</html>




